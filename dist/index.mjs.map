{"version":3,"sources":["../src/facades.ts"],"sourcesContent":["import firebase from 'firebase/compat/app';\nimport 'firebase/auth';\nimport { registerPlugin } from '@capacitor/core';\n\nimport type {\n  AppleSignInResult,\n  CapacitorFirebaseAuthPlugin,\n  FacebookSignInResult,\n  GoogleSignInResult,\n  PhoneSignInResult,\n  TwitterSignInResult,\n  SignInOptionsMap,\n} from './definitions';\n\nexport const CapacitorFirebaseAuth =\n  registerPlugin<CapacitorFirebaseAuthPlugin>('CapacitorFirebaseAuth', {\n    web: async () => ({\n      signIn: async () => {\n        throw new Error('web not implemented');\n      },\n      link: async () => {\n        throw new Error('web not implemented');\n      },\n      signOut: async () => {\n        throw new Error('web not implemented');\n      },\n    }),\n  });\nconst plugin = CapacitorFirebaseAuth;\n\nabstract class BaseProvider {\n  public static PROVIDER_ID: string;\n}\n\ntype MaybePromise<T> = T | Promise<T>;\n\nclass AppleAuthProvider extends firebase.auth.OAuthProvider {\n  public static PROVIDER_ID = 'apple.com';\n  constructor() {\n    super(AppleAuthProvider.PROVIDER_ID);\n  }\n}\n\nconst registerProvider = <Prov extends typeof BaseProvider, SignInResult>(\n  Provider: Prov,\n  buildCredential: (\n    signInResult: SignInResult,\n    Provider: Prov\n  ) => MaybePromise<firebase.auth.OAuthCredential | null>\n) => {\n  return {\n    providerId: Provider.PROVIDER_ID,\n    Provider,\n    buildCredential,\n  };\n};\n\nconst PROVIDER_MAP = {\n  ['google.com']: registerProvider(\n    firebase.auth.GoogleAuthProvider,\n    ({ idToken }: GoogleSignInResult, Provider) => Provider.credential(idToken)\n  ),\n  ['apple.com']: registerProvider(\n    AppleAuthProvider,\n    ({ idToken, rawNonce }: AppleSignInResult, Provider) => {\n      const provider = new Provider();\n      provider.addScope('email');\n      provider.addScope('name');\n      return provider.credential({ idToken, rawNonce });\n    }\n  ),\n  ['facebook.com']: registerProvider(\n    firebase.auth.FacebookAuthProvider,\n    ({ idToken }: FacebookSignInResult, Provider) =>\n      Provider.credential(idToken)\n  ),\n  ['twitter.com']: registerProvider(\n    firebase.auth.TwitterAuthProvider,\n    ({ idToken, secret }: TwitterSignInResult, Provider) =>\n      Provider.credential(idToken, secret)\n  ),\n  phone: registerProvider(\n    firebase.auth.PhoneAuthProvider,\n    ({ verificationId, verificationCode }: PhoneSignInResult, Provider) =>\n      verificationCode\n        ? Provider.credential(verificationId, verificationCode)\n        : null\n  ),\n};\n\ntype SignInResultMap = {\n  [K in keyof typeof PROVIDER_MAP]: Parameters<\n    typeof PROVIDER_MAP[K]['buildCredential']\n  >[0];\n};\n\n/**\n * Call the sign in method on native layer and sign in on web layer with retrieved credentials.\n */\nexport const signIn = async <ProviderId extends keyof typeof PROVIDER_MAP>(\n  /** The provider ID or name. */\n  providerId: ProviderId,\n  /** Additional information for provider */\n  ...[data]: SignInOptionsMap[ProviderId] extends never\n    ? []\n    : [data: SignInOptionsMap[ProviderId]]\n) => {\n  const config = PROVIDER_MAP[providerId];\n  if (!config) throw new Error(`Provider ${providerId} not found`);\n\n  const { Provider, buildCredential } = config;\n\n  const signInResult = await plugin.signIn<SignInResultMap[ProviderId]>({\n    providerId,\n    data,\n  });\n\n  const oauthCred = await buildCredential(signInResult as any, Provider as any);\n  if (!oauthCred) return null; // abort if no credential\n\n  const userCredential = await firebase\n    .app()\n    .auth()\n    .signInWithCredential(oauthCred);\n\n  return { userCredential, result: signInResult };\n};\n\n/**\n * Call the link method on native layer and link on web layer with retrieved credentials.\n */\nexport const link = async <ProviderId extends keyof typeof PROVIDER_MAP>(\n  /** The provider ID or name. */\n  providerId: ProviderId,\n  /** Additional information for provider */\n  ...[data]: SignInOptionsMap[ProviderId] extends never\n    ? []\n    : [data: SignInOptionsMap[ProviderId]]\n) => {\n  const config = PROVIDER_MAP[providerId];\n  if (!config) throw new Error(`Provider ${providerId} not found`);\n\n  const { Provider, buildCredential } = config;\n\n  const result = await plugin.link<SignInResultMap[ProviderId]>({\n    providerId,\n    data,\n  });\n\n  const oauthCred = await buildCredential(result as any, Provider as any);\n  if (!oauthCred) return null; // abort if no credential\n\n  // web link\n  const authUser = firebase.app().auth().currentUser;\n  if (!authUser) {\n    throw new Error('No user to link to');\n  }\n\n  const userCredential = await authUser.linkWithCredential(oauthCred);\n\n  return { userCredential, result };\n};\n\n/**\n * Call sign out method on native and web layers.\n */\nexport const signOut = async () => {\n  // native sign out\n  await plugin.signOut({});\n\n  // web sign out\n  await firebase.app().auth().signOut();\n};\n"],"mappings":"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","names":["firebase","registerPlugin","CapacitorFirebaseAuth","registerPlugin","plugin","_AppleAuthProvider","firebase","AppleAuthProvider","__publicField","registerProvider","Provider","buildCredential","PROVIDER_MAP","idToken","rawNonce","provider","secret","verificationId","verificationCode","signIn","providerId","data","config","signInResult","plugin","oauthCred","link","result","authUser","signOut"]}