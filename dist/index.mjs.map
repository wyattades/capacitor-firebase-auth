{"version":3,"sources":["../src/facades.ts"],"sourcesContent":["import { registerPlugin } from '@capacitor/core';\nimport {\n  Auth,\n  AuthCredential,\n  FacebookAuthProvider,\n  GoogleAuthProvider,\n  OAuthProvider,\n  PhoneAuthProvider,\n  TwitterAuthProvider,\n  getAuth,\n  linkWithCredential,\n  signInWithCredential,\n} from 'firebase/auth';\n\nimport type {\n  AppleSignInResult,\n  CapacitorFirebaseAuthPlugin,\n  FacebookSignInResult,\n  GoogleSignInResult,\n  PhoneSignInResult,\n  SignInOptionsMap,\n  TwitterSignInResult,\n} from './definitions';\n\nexport const CapacitorFirebaseAuth =\n  registerPlugin<CapacitorFirebaseAuthPlugin>('CapacitorFirebaseAuth', {\n    web: async () => ({\n      signIn: async () => {\n        throw new Error('web not implemented');\n      },\n      link: async () => {\n        throw new Error('web not implemented');\n      },\n      signOut: async () => {\n        throw new Error('web not implemented');\n      },\n    }),\n  });\nconst plugin = CapacitorFirebaseAuth;\n\nabstract class BaseProvider {\n  public static PROVIDER_ID: string;\n  constructor(_auth?: Auth) {}\n}\n\ntype MaybePromise<T> = T | Promise<T>;\n\nclass AppleAuthProvider extends OAuthProvider {\n  public static PROVIDER_ID = 'apple.com';\n  constructor() {\n    super(AppleAuthProvider.PROVIDER_ID);\n  }\n}\n\nconst registerProvider = <Prov extends typeof BaseProvider, SignInResult>(\n  Provider: Prov,\n  buildCredential: (\n    signInResult: SignInResult,\n    Provider: Prov\n  ) => MaybePromise<AuthCredential | null>\n) => {\n  return {\n    providerId: Provider.PROVIDER_ID,\n    Provider,\n    buildCredential,\n  };\n};\n\nconst PROVIDER_MAP = {\n  ['google.com']: registerProvider(\n    GoogleAuthProvider,\n    ({ idToken }: GoogleSignInResult, Provider) => Provider.credential(idToken)\n  ),\n  ['apple.com']: registerProvider(\n    AppleAuthProvider,\n    ({ idToken, rawNonce }: AppleSignInResult, Provider) => {\n      const provider = new Provider();\n\n      provider.addScope('email');\n      provider.addScope('name');\n      return provider.credential({ idToken, rawNonce });\n    }\n  ),\n  ['facebook.com']: registerProvider(\n    FacebookAuthProvider,\n    ({ idToken }: FacebookSignInResult, Provider) =>\n      Provider.credential(idToken)\n  ),\n  ['twitter.com']: registerProvider(\n    TwitterAuthProvider,\n    ({ idToken, secret }: TwitterSignInResult, Provider) =>\n      Provider.credential(idToken, secret)\n  ),\n  phone: registerProvider(\n    PhoneAuthProvider,\n    ({ verificationId, verificationCode }: PhoneSignInResult, Provider) =>\n      verificationCode\n        ? Provider.credential(verificationId, verificationCode)\n        : null\n  ),\n};\n\ntype SignInResultMap = {\n  [K in keyof typeof PROVIDER_MAP]: Parameters<\n    typeof PROVIDER_MAP[K]['buildCredential']\n  >[0];\n};\n\n/**\n * Call the sign in method on native layer and sign in on web layer with retrieved credentials.\n */\nexport const signIn = async <ProviderId extends keyof typeof PROVIDER_MAP>(\n  /** The provider ID or name. */\n  providerId: ProviderId,\n  /** Additional information for provider */\n  ...[data]: SignInOptionsMap[ProviderId] extends never\n    ? []\n    : [data: SignInOptionsMap[ProviderId]]\n) => {\n  const config = PROVIDER_MAP[providerId];\n  if (!config) throw new Error(`Provider ${providerId} not found`);\n\n  const { Provider, buildCredential } = config;\n\n  const signInResult = await plugin.signIn<SignInResultMap[ProviderId]>({\n    providerId,\n    data,\n  });\n\n  const oauthCred = await buildCredential(signInResult as any, Provider as any);\n  if (!oauthCred) return null; // abort if no credential\n\n  const userCredential = await signInWithCredential(getAuth(), oauthCred);\n\n  return { userCredential, result: signInResult };\n};\n\n/**\n * Call the link method on native layer and link on web layer with retrieved credentials.\n */\nexport const link = async <ProviderId extends keyof typeof PROVIDER_MAP>(\n  /** The provider ID or name. */\n  providerId: ProviderId,\n  /** Additional information for provider */\n  ...[data]: SignInOptionsMap[ProviderId] extends never\n    ? []\n    : [data: SignInOptionsMap[ProviderId]]\n) => {\n  const config = PROVIDER_MAP[providerId];\n  if (!config) throw new Error(`Provider ${providerId} not found`);\n\n  const { Provider, buildCredential } = config;\n\n  const result = await plugin.link<SignInResultMap[ProviderId]>({\n    providerId,\n    data,\n  });\n\n  const oauthCred = await buildCredential(result as any, Provider as any);\n  if (!oauthCred) return null; // abort if no credential\n\n  // web link\n  const authUser = getAuth().currentUser;\n  if (!authUser) {\n    throw new Error('No user to link to');\n  }\n\n  const userCredential = await linkWithCredential(authUser, oauthCred);\n\n  return { userCredential, result };\n};\n\n/**\n * Call sign out method on native and web layers.\n */\nexport const signOut = async () => {\n  // native sign out\n  await plugin.signOut({});\n\n  // web sign out\n  await getAuth().signOut();\n};\n"],"mappings":"wKAAA,OAAS,kBAAAA,MAAsB,kBAC/B,OAGE,wBAAAC,EACA,sBAAAC,EACA,iBAAAC,EACA,qBAAAC,EACA,uBAAAC,EACA,WAAAC,EACA,sBAAAC,EACA,wBAAAC,MACK,gBAYA,IAAMC,EACXC,EAA4C,wBAAyB,CACnE,IAAK,UAAa,CAChB,OAAQ,SAAY,CAClB,MAAM,IAAI,MAAM,qBAAqB,CACvC,EACA,KAAM,SAAY,CAChB,MAAM,IAAI,MAAM,qBAAqB,CACvC,EACA,QAAS,SAAY,CACnB,MAAM,IAAI,MAAM,qBAAqB,CACvC,CACF,EACF,CAAC,EACGC,EAASF,EASf,IAAMG,EAAN,cAAgCC,CAAc,CAE5C,aAAc,CACZ,MAAMD,EAAkB,WAAW,CACrC,CACF,EALME,EAANF,EACEG,EADID,EACU,cAAc,aAM9B,IAAME,EAAmB,CACvBC,EACAC,KAKO,CACL,WAAYD,EAAS,YACrB,SAAAA,EACA,gBAAAC,CACF,GAGIC,EAAe,CACnB,CAAC,cAAeH,EACdI,EACA,CAAC,CAAE,QAAAC,CAAQ,EAAuBJ,IAAaA,EAAS,WAAWI,CAAO,CAC5E,EACA,CAAC,aAAcL,EACbF,EACA,CAAC,CAAE,QAAAO,EAAS,SAAAC,CAAS,EAAsBL,IAAa,CACtD,IAAMM,EAAW,IAAIN,EAErB,OAAAM,EAAS,SAAS,OAAO,EACzBA,EAAS,SAAS,MAAM,EACjBA,EAAS,WAAW,CAAE,QAAAF,EAAS,SAAAC,CAAS,CAAC,CAClD,CACF,EACA,CAAC,gBAAiBN,EAChBQ,EACA,CAAC,CAAE,QAAAH,CAAQ,EAAyBJ,IAClCA,EAAS,WAAWI,CAAO,CAC/B,EACA,CAAC,eAAgBL,EACfS,EACA,CAAC,CAAE,QAAAJ,EAAS,OAAAK,CAAO,EAAwBT,IACzCA,EAAS,WAAWI,EAASK,CAAM,CACvC,EACA,MAAOV,EACLW,EACA,CAAC,CAAE,eAAAC,EAAgB,iBAAAC,CAAiB,EAAsBZ,IACxDY,EACIZ,EAAS,WAAWW,EAAgBC,CAAgB,EACpD,IACR,CACF,EAWaC,EAAS,MAEpBC,KAEG,CAACC,CAAI,IAGL,CACH,IAAMC,EAASd,EAAaY,GAC5B,GAAI,CAACE,EAAQ,MAAM,IAAI,MAAM,YAAYF,aAAsB,EAE/D,GAAM,CAAE,SAAAd,EAAU,gBAAAC,CAAgB,EAAIe,EAEhCC,EAAe,MAAMC,EAAO,OAAoC,CACpE,WAAAJ,EACA,KAAAC,CACF,CAAC,EAEKI,EAAY,MAAMlB,EAAgBgB,EAAqBjB,CAAe,EAC5E,OAAKmB,EAIE,CAAE,eAFc,MAAMC,EAAqBC,EAAQ,EAAGF,CAAS,EAE7C,OAAQF,CAAa,EAJvB,IAKzB,EAKaK,EAAO,MAElBR,KAEG,CAACC,CAAI,IAGL,CACH,IAAMC,EAASd,EAAaY,GAC5B,GAAI,CAACE,EAAQ,MAAM,IAAI,MAAM,YAAYF,aAAsB,EAE/D,GAAM,CAAE,SAAAd,EAAU,gBAAAC,CAAgB,EAAIe,EAEhCO,EAAS,MAAML,EAAO,KAAkC,CAC5D,WAAAJ,EACA,KAAAC,CACF,CAAC,EAEKI,EAAY,MAAMlB,EAAgBsB,EAAevB,CAAe,EACtE,GAAI,CAACmB,EAAW,OAAO,KAGvB,IAAMK,EAAWH,EAAQ,EAAE,YAC3B,GAAI,CAACG,EACH,MAAM,IAAI,MAAM,oBAAoB,EAKtC,MAAO,CAAE,eAFc,MAAMC,EAAmBD,EAAUL,CAAS,EAE1C,OAAAI,CAAO,CAClC,EAKaG,EAAU,SAAY,CAEjC,MAAMR,EAAO,QAAQ,CAAC,CAAC,EAGvB,MAAMG,EAAQ,EAAE,QAAQ,CAC1B","names":["registerPlugin","FacebookAuthProvider","GoogleAuthProvider","OAuthProvider","PhoneAuthProvider","TwitterAuthProvider","getAuth","linkWithCredential","signInWithCredential","CapacitorFirebaseAuth","registerPlugin","plugin","_AppleAuthProvider","OAuthProvider","AppleAuthProvider","__publicField","registerProvider","Provider","buildCredential","PROVIDER_MAP","GoogleAuthProvider","idToken","rawNonce","provider","FacebookAuthProvider","TwitterAuthProvider","secret","PhoneAuthProvider","verificationId","verificationCode","signIn","providerId","data","config","signInResult","plugin","oauthCred","signInWithCredential","getAuth","link","result","authUser","linkWithCredential","signOut"]}